<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>R | Matt Ashby</title>
    <link>http://lesscrime.info/tag/r/</link>
      <atom:link href="http://lesscrime.info/tag/r/index.xml" rel="self" type="application/rss+xml" />
    <description>R</description>
    <generator>Wowchemy (https://wowchemy.com)</generator><language>en-us</language><copyright>CC-BY</copyright><lastBuildDate>Thu, 10 Dec 2020 00:00:00 +0000</lastBuildDate>
    <image>
      <url>http://lesscrime.info/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png</url>
      <title>R</title>
      <link>http://lesscrime.info/tag/r/</link>
    </image>
    
    <item>
      <title>Tutorial: Calculating disparities in stop and search</title>
      <link>http://lesscrime.info/post/calculating-disparities-in-stop-and-search/</link>
      <pubDate>Thu, 10 Dec 2020 00:00:00 +0000</pubDate>
      <guid>http://lesscrime.info/post/calculating-disparities-in-stop-and-search/</guid>
      <description>
&lt;link href=&#34;http://lesscrime.info/rmarkdown-libs/anchor-sections/anchor-sections.css&#34; rel=&#34;stylesheet&#34; /&gt;
&lt;script src=&#34;http://lesscrime.info/rmarkdown-libs/anchor-sections/anchor-sections.js&#34;&gt;&lt;/script&gt;


&lt;p&gt;I recently published a &lt;a href=&#34;http://lesscrime.info/publication/stop-search-london-2020-q3/&#34;&gt;report on how stop and search is used in London&lt;/a&gt;. Although the report contained lots of information, it was probably inevitable that people would focus on the figures for disparities in stop and search rates between ethnic groups. This has led several people to ask how I calculated these disparities, so I’ll set that out in this tutorial.&lt;/p&gt;
&lt;div id=&#34;prepare-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Prepare the data&lt;/h2&gt;
&lt;p&gt;First, we load the &lt;a href=&#34;https://tidyverse.org/&#34;&gt;&lt;code&gt;tidyverse&lt;/code&gt;&lt;/a&gt; R package, which contains various functions for handling data and the &lt;a href=&#34;https://scales.r-lib.org/&#34;&gt;&lt;code&gt;scales&lt;/code&gt;&lt;/a&gt; package for formatting numbers.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(&amp;quot;scales&amp;quot;)
library(&amp;quot;tidyverse&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;To calculate search rates we need data on searches and data on population. The holy grail of population data would be an accurate representation of the number of people available to be searched in a particular place, since a person in a public place is vastly more likely to be searched in relative terms than someone sitting watching TV in their kitchen. Unfortunately, this data doesn’t exist, so we have to rely on residential population data. As I discuss in the report, this is not perfect, but it is probably acceptable if we calculate search rates for London as a whole, rather than particular neighbourhoods.&lt;/p&gt;
&lt;p&gt;Search data is available from &lt;a href=&#34;https://data.police.uk/data/&#34;&gt;data.police.uk&lt;/a&gt; but is unfortunately stuck behind a web form, meaning it is difficult to download directly within an R script. I’ve instead downloaded the stop-and-search data for the Metropolitan Police for July to September 2020. This is slightly different to the data I used for the report, which also included stops by the City of London Police and British Transport Police in London, but almost all searches in London are done by the Met, so this is unlikely to affect the results much &lt;a href=&#34;#fn1&#34; class=&#34;footnote-ref&#34; id=&#34;fnref1&#34;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# you can download a copy of the data file I downloaded from data.police.uk 
# from https://github.com/mpjashby/lesscrime.info/tree/master/public/post/calculating-disparities-in-stop-and-search/met_stop_and_search_data_july_to_september_2020.zip

# the search data comes in a ZIP archive, so we will unzip to a temporary
# directory and then read it from there
unzip(
  zipfile = &amp;quot;met_stop_and_search_data_july_to_september_2020.zip&amp;quot;,
  exdir = str_glue(&amp;quot;{tempdir()}/stop-search-data/&amp;quot;)
)

# now read all the CSV files from the temporary directory and combine them into
# a single data frame
searches &amp;lt;- str_glue(&amp;quot;{tempdir()}/stop-search-data/&amp;quot;) %&amp;gt;% 
  dir(pattern = &amp;quot;csv$&amp;quot;, full.names = TRUE, recursive = TRUE) %&amp;gt;% 
  map(read_csv) %&amp;gt;% 
  bind_rows() %&amp;gt;% 
  # convert the column names to be easier to work with in R code
  janitor::clean_names()&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   Type = col_character(),
##   Date = col_datetime(format = &amp;quot;&amp;quot;),
##   `Part of a policing operation` = col_logical(),
##   `Policing operation` = col_logical(),
##   Latitude = col_double(),
##   Longitude = col_double(),
##   Gender = col_character(),
##   `Age range` = col_character(),
##   `Self-defined ethnicity` = col_character(),
##   `Officer-defined ethnicity` = col_character(),
##   Legislation = col_character(),
##   `Object of search` = col_character(),
##   Outcome = col_character(),
##   `Outcome linked to object of search` = col_logical(),
##   `Removal of more than just outer clothing` = col_logical()
## )
## 
## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   Type = col_character(),
##   Date = col_datetime(format = &amp;quot;&amp;quot;),
##   `Part of a policing operation` = col_logical(),
##   `Policing operation` = col_logical(),
##   Latitude = col_double(),
##   Longitude = col_double(),
##   Gender = col_character(),
##   `Age range` = col_character(),
##   `Self-defined ethnicity` = col_character(),
##   `Officer-defined ethnicity` = col_character(),
##   Legislation = col_character(),
##   `Object of search` = col_character(),
##   Outcome = col_character(),
##   `Outcome linked to object of search` = col_logical(),
##   `Removal of more than just outer clothing` = col_logical()
## )
## 
## 
## ── Column specification ────────────────────────────────────────────────────────
## cols(
##   Type = col_character(),
##   Date = col_datetime(format = &amp;quot;&amp;quot;),
##   `Part of a policing operation` = col_logical(),
##   `Policing operation` = col_logical(),
##   Latitude = col_double(),
##   Longitude = col_double(),
##   Gender = col_character(),
##   `Age range` = col_character(),
##   `Self-defined ethnicity` = col_character(),
##   `Officer-defined ethnicity` = col_character(),
##   Legislation = col_character(),
##   `Object of search` = col_character(),
##   Outcome = col_character(),
##   `Outcome linked to object of search` = col_logical(),
##   `Removal of more than just outer clothing` = col_logical()
## )&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# select only the columns we need
searches &amp;lt;- select(searches, type, gender, age_range, self_defined_ethnicity)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This gives us a data frame where each row represents a stop and search of one person or vehicle. The first few rows:&lt;/p&gt;
&lt;table&gt;
&lt;colgroup&gt;
&lt;col width=&#34;20%&#34; /&gt;
&lt;col width=&#34;5%&#34; /&gt;
&lt;col width=&#34;7%&#34; /&gt;
&lt;col width=&#34;66%&#34; /&gt;
&lt;/colgroup&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;type&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;gender&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;age_range&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;self_defined_ethnicity&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;Person and Vehicle search&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black/African/Caribbean/Black British - Any other Black/African/Caribbean background&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;Person search&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White - English/Welsh/Scottish/Northern Irish/British&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;Person search&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White - English/Welsh/Scottish/Northern Irish/British&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;Person search&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White - Any other White background&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;Person search&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;NA&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Other ethnic group - Not stated&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;Person search&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Other ethnic group - Not stated&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;a href=&#34;https://data.london.gov.uk/dataset/ethnic-group-population-projections&#34;&gt;Population estimates for London for 2020&lt;/a&gt; are available on the Mayor of London’s website. These are only estimates, but are probably the best figures available because the latest census data are now nearly a decade out of date. We won’t get a more-accurate measure of London population until data from the 2021 Census is published in 2022 or 2023.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# download the data to a temporary file
# if this file no longer exists, check 
# https://data.london.gov.uk/dataset/ethnic-group-population-projections for the
# current URL
download.file(
  url = &amp;quot;https://data.london.gov.uk/download/ethnic-group-population-projections/a9598ef0-808c-4f96-9eac-8bb314bd92cd/Ethnic%20group%20projections%20%282016-based%20central%20trend%29.xlsx&amp;quot;,
  destfile = str_glue(&amp;quot;{tempdir()}/population_data.xlsx&amp;quot;)
)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We now load the population data and format it so that it is easier to work with.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# load two sheets from the same Excel file, one for female population and one
# for male
people &amp;lt;- map_dfr(
  c(&amp;quot;Population - Females&amp;quot;, &amp;quot;Population - Males&amp;quot;), 
  ~ readxl::read_excel(path = str_glue(&amp;quot;{tempdir()}/population_data.xlsx&amp;quot;), 
                       sheet = .)
)

# filter out rows of data we do not need
people &amp;lt;- filter(
  people,
  # filter out rows that have totals for all ages combined, since we only want 
  # data for each age group separately
  age != &amp;quot;All ages&amp;quot;, 
  # filter out rows that have values for specific boroughs, since we only want
  # data for London as a whole
  borough == &amp;quot;Greater London&amp;quot;,
  # filter out rows that have totals for all ethnic groups combined, since we 
  # only want data for each group separately
  !ethnic_group %in% c(&amp;quot;All persons&amp;quot;, &amp;quot;BAME&amp;quot;)
)

# reformat the data into the format that we need
people &amp;lt;- mutate(
  people,
  # convert age to a numeric value so we can use between()
  age = as.numeric(age),
  # categorise ages into age ranges that match the stop and search data
  age_range = case_when(
    between(age, 0, 9) ~ &amp;quot;under 10&amp;quot;,
    between(age, 10, 17) ~ &amp;quot;10-17&amp;quot;,
    between(age, 18, 24) ~ &amp;quot;18-24&amp;quot;,
    between(age, 25, 34) ~ &amp;quot;25-34&amp;quot;,
    age &amp;gt; 34 ~ &amp;quot;over 34&amp;quot;,
    TRUE ~ NA_character_
  ),
  # change sex to lower case
  sex = str_to_lower(sex)
) %&amp;gt;% 
  # change the name of the variable containing the population count for each
  # group
  rename(people = `2020`)

# select only the columns we need
people &amp;lt;- select(people, sex, age_range, ethnic_group, people)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This gives us a data frame where each row represents the number of residents in London in each category of age, sex and ethnicity. Again, the first few rows:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;sex&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;age_range&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ethnic_group&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;people&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;under 10&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White British&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;19,429&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;under 10&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White British&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;18,616&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;under 10&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White British&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;17,883&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;under 10&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White British&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;17,235&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;under 10&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White British&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;16,890&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;under 10&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White British&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;16,741&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&#34;count-searches-and-people&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Count searches and people&lt;/h2&gt;
&lt;p&gt;To calculate search rates, we need to calculate the number of searches involving people in each group. Before we can do this, we need to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;rename some columns and the values of the ‘sex’ variable so they match those in the population data,&lt;/li&gt;
&lt;li&gt;aggregate ethnic groups into the categories ‘Asian’, ‘Black’, ‘Mixed’, ‘Other’ and ‘White’, since the number of searches in some of the smaller ethnic groups is too low to draw conclusions from,&lt;/li&gt;
&lt;li&gt;remove searches of unattended vehicles (or attended vehicles where no people were searched), since we don’t have age, sex and ethnicity data for those,&lt;/li&gt;
&lt;li&gt;remove searches for which one or more of age, sex and ethnicity are missing, or where sex is listed as ‘other’ since there is no population data for this group.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;search_counts &amp;lt;- searches %&amp;gt;% 
  # rename columns so they match the population data
  rename(sex = gender, ethnic_group = self_defined_ethnicity) %&amp;gt;% 
  # change sex to lower case
  mutate(sex = str_to_lower(sex)) %&amp;gt;% 
  # aggregate ethnic groups by taking the first word (&amp;#39;White&amp;#39;, &amp;#39;Black&amp;#39; etc) from 
  # each group name
  mutate(ethnic_group = str_extract(ethnic_group, &amp;quot;^\\w+&amp;quot;)) %&amp;gt;% 
  filter(
    # filter out vehicle-only searches
    type %in% c(&amp;quot;Person search&amp;quot;, &amp;quot;Person and Vehicle search&amp;quot;),
    # filter out rows with missing, age, sex or ethnicity
    !is.na(age_range), !is.na(ethnic_group), sex %in% c(&amp;quot;female&amp;quot;, &amp;quot;male&amp;quot;)
  ) %&amp;gt;% 
  # count searches in each category
  count(sex, age_range, ethnic_group, name = &amp;quot;searches&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We must also count the number of people in each population group, since in the raw data there is a separate row for each individual year of age. We also aggregate ethnicity categories to match those in the search data.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;people_counts &amp;lt;- people %&amp;gt;% 
  mutate(
    # 
    ethnic_group = case_when(
      ethnic_group %in% c(&amp;quot;Bangladeshi&amp;quot;, &amp;quot;Indian&amp;quot;, &amp;quot;Pakistani&amp;quot;, &amp;quot;Other Asian&amp;quot;) ~ 
        &amp;quot;Asian&amp;quot;,
      ethnic_group %in% c(&amp;quot;Black African&amp;quot;, &amp;quot;Black Caribbean&amp;quot;, &amp;quot;Other Black&amp;quot;) ~
        &amp;quot;Black&amp;quot;,
      ethnic_group %in% c(&amp;quot;White &amp;amp; Asian&amp;quot;, &amp;quot;White &amp;amp; Black African&amp;quot;, 
                          &amp;quot;White &amp;amp; Black Caribbean&amp;quot;, &amp;quot;Other Mixed&amp;quot;) ~
        &amp;quot;Mixed&amp;quot;,
      ethnic_group %in% c(&amp;quot;White British&amp;quot;, &amp;quot;White Irish&amp;quot;, &amp;quot;Other White&amp;quot;) ~ 
        &amp;quot;White&amp;quot;,
      TRUE ~ &amp;quot;Other&amp;quot;
    )
  ) %&amp;gt;% 
  # count searches in each category
  count(sex, age_range, ethnic_group, wt = people, name = &amp;quot;people&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now that the two datasets are in the same format, we can merge them to create a single dataset to work with.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;counts &amp;lt;- full_join(
  search_counts, 
  people_counts, 
  by = c(&amp;quot;sex&amp;quot;, &amp;quot;age_range&amp;quot;, &amp;quot;ethnic_group&amp;quot;)
) %&amp;gt;% 
  # population groups in which no one was searched will have missing values for
  # the search data, so we convert these missing values to zeros
  replace_na(list(searches = 0))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The first few rows of data are:&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;sex&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;age_range&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ethnic_group&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;searches&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;people&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;16&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;87,696&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;77&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;81,226&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Mixed&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;31&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;41,925&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Other&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;113&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;23,377&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;300&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;180,885&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;134&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;64,680&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div id=&#34;calculating-search-rates-and-disparity&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Calculating search rates and disparity&lt;/h2&gt;
&lt;p&gt;Now we have data we can work with, we can calculate search rates per 1,000 people in a particular population group and for the population as a whole. Note, however, that some demographic groups have very small numbers of searches so the calculated rates are likely to be unstable. To deal with this, we will only calculate rates for groups for which there were at least 100 searches between July and September 2020. We will also exclude the ‘Other’ ethnicity category, because it covers such a broad range of different people that it is difficult to interpret the results.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;overall_rate &amp;lt;- sum(counts$searches) / (sum(counts$people) / 1000)

group_rates &amp;lt;- counts %&amp;gt;% 
  filter(ethnic_group != &amp;quot;Other&amp;quot;, searches &amp;gt;= 100) %&amp;gt;% 
  mutate(search_rate = searches / (people / 1000))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We could show these values as a table, but there would probably be too much information to easily digest. Instead we can show the different search rates as a chart (remember some values will be missing because there were fewer than 100 searches of people in that group).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(
  group_rates,
  aes(
    # set the order of the age groups so that the follow the natural age order
    x = fct_relevel(age_range, &amp;quot;10-17&amp;quot;, &amp;quot;18-24&amp;quot;, &amp;quot;25-34&amp;quot;, &amp;quot;over 34&amp;quot;), 
    y = search_rate, 
    fill = sex, 
    # format the rate for printing
    label = number(search_rate, accuracy = 0.1)
  )
) +
  geom_col() +
  geom_text(size = 3.5, vjust = 0, nudge_y = 2) +
  facet_grid(cols = vars(ethnic_group), rows = vars(sex)) +
  labs(
    title = &amp;quot;Stop-and-search rates for different deomgraphic groups&amp;quot;,
    x = NULL, 
    y = &amp;quot;search rate per 1,000 people&amp;quot;
  ) +
  theme_minimal() +
  theme(
    legend.position = &amp;quot;none&amp;quot;,
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    plot.title.position = &amp;quot;plot&amp;quot;
  )&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;http://lesscrime.info/post/calculating-disparities-in-stop-and-search_files/figure-html/search%20rates%20chart-1.png&#34; width=&#34;672&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&lt;/p&gt;
&lt;p&gt;To calculate disparity ratios, we simply divide the search rate for each group by the overall search rate of 6.20 searches per 1,000 people.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;group_disparity &amp;lt;- mutate(group_rates, disparity = search_rate / overall_rate)&lt;/code&gt;&lt;/pre&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr class=&#34;header&#34;&gt;
&lt;th align=&#34;left&#34;&gt;sex&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;age_range&lt;/th&gt;
&lt;th align=&#34;left&#34;&gt;ethnic_group&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;searches&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;people&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;search_rate&lt;/th&gt;
&lt;th align=&#34;right&#34;&gt;disparity&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;5,713.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;52,159&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;109.5&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;17.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;3,805.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;81,313&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;46.8&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;7.5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;3,058.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;75,695&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;40.4&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;6.5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2,624.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;83,789&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;31.3&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;5.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Mixed&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;822.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;29,774&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;27.6&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4.5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;5,355.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;199,372&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;26.9&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2,737.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;189,647&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;14.4&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2,221.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;174,204&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;12.7&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;987.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;93,309&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;10.6&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Mixed&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;450.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;43,712&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;10.3&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Mixed&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;427.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;44,383&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;9.6&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4,461.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;504,165&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;8.8&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;over 34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2,085.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;258,994&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;8.1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;252.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;47,977&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;5.3&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.8&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;over 34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Mixed&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;253.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;61,582&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4.1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.7&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;724.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;209,483&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;3.5&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;over 34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;4,579.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1,435,342&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;3.2&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;male&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;over 34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1,124.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;413,450&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2.7&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.4&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;18-24&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Asian&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;134.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;64,680&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2.1&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;180.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;88,000&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;2.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;10-17&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;300.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;180,885&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.7&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;25-34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;666.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;487,537&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1.4&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.2&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;odd&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;over 34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;White&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;859.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;1,427,660&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.6&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr class=&#34;even&#34;&gt;
&lt;td align=&#34;left&#34;&gt;female&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;over 34&lt;/td&gt;
&lt;td align=&#34;left&#34;&gt;Black&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;186.0&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;334,834&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.6&lt;/td&gt;
&lt;td align=&#34;right&#34;&gt;0.1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;These disparity ratios are slightly different from those in last week’s report, because the data used here are only for the Met, not the data for all three London police forces used in the report. Nevertheless they are similar overall, and in particular the ordering of the groups from highest to lowest is almost identical.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;calculating-age--and-sex-standardised-disparity-ratios&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Calculating age- and sex-standardised disparity ratios&lt;/h1&gt;
&lt;p&gt;For some purposes, comparing specific age/sex/ethnicity groups to the population as a whole may not be of interest. For example, we might be interested in comparing people in non-white ethnic groups to white people of the same age and sex. To do this, we have to arrange our data frame into a different format so we can divide the search rate for each group by the corresponding rate for white people.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;standardised_disparity &amp;lt;- group_disparity %&amp;gt;% 
  # remove columns we don&amp;#39;t need, which makes pivot_wider() work more easily
  select(-searches, -people, -disparity) %&amp;gt;% 
  # make our data &amp;#39;wider&amp;#39;, so we can divide one column by another
  # for an explanation of long vs wide data, see 
  # https://sejdemyr.github.io/r-tutorials/basics/wide-and-long/
  pivot_wider(names_from = ethnic_group, values_from = search_rate) %&amp;gt;% 
  # divide each search rate by the corresponding search rate for white people
  mutate(
    across(where(is.numeric), ~ . / White, .names = &amp;quot;{.col}_disparity&amp;quot;)
  ) %&amp;gt;% 
  # convert the data back to &amp;#39;long&amp;#39; format
  pivot_longer(where(is.numeric), values_to = &amp;quot;value&amp;quot;) %&amp;gt;% 
  # further convert the data to a semi-wide format, so that each row represents
  # one demographic group, as in the original data
  separate(name, into = c(&amp;quot;ethnic_group&amp;quot;, &amp;quot;cat&amp;quot;), fill = &amp;quot;right&amp;quot;) %&amp;gt;% 
  replace_na(list(cat = &amp;quot;search_rate&amp;quot;)) %&amp;gt;% 
  pivot_wider(names_from = &amp;quot;cat&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can visualise these standardised disparities.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;ggplot(
  standardised_disparity, 
  aes(
    x = ethnic_group, 
    # show age groups in natural order
    y = fct_rev(fct_relevel(age_range, &amp;quot;10-17&amp;quot;, &amp;quot;18-24&amp;quot;, &amp;quot;25-34&amp;quot;, &amp;quot;over 34&amp;quot;)),
    # set text colour so it is visible over the background fill
    colour = disparity &amp;gt; diff(range(disparity, na.rm = TRUE)) / 2,
    fill = replace_na(disparity, 0),
    # format number for printing
    label = replace_na(number(disparity, accuracy = 0.01), &amp;quot;–&amp;quot;)
  )
) +
  geom_raster() +
  geom_text(na.rm = TRUE) +
  scale_x_discrete(position = &amp;quot;top&amp;quot;) +
  scale_colour_manual(values = c(`TRUE` = &amp;quot;grey90&amp;quot;, `FALSE` = &amp;quot;grey10&amp;quot;)) +
  scale_fill_gradient(low = &amp;quot;white&amp;quot;, high = &amp;quot;darkblue&amp;quot;) +
  facet_grid(cols = vars(sex)) +
  labs(
    title = &amp;quot;Standardised stop-and-search disparity ratios&amp;quot;, 
    subtitle = &amp;quot;Rate of search rates for each group relative to white people of the same age and sex&amp;quot;,
    x = NULL, 
    y = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    legend.position = &amp;quot;none&amp;quot;,
    panel.grid = element_blank(),
    plot.title.position = &amp;quot;plot&amp;quot;,
    strip.placement = &amp;quot;outside&amp;quot;,
    strip.text = element_text(face = &amp;quot;bold&amp;quot;, size = 10)
  )&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;img src=&#34;http://lesscrime.info/post/calculating-disparities-in-stop-and-search_files/figure-html/standarised%20disparities%20chart-1.png&#34; width=&#34;672&#34; style=&#34;display: block; margin: auto;&#34; /&gt;&lt;/p&gt;
&lt;div id=&#34;comparing-every-group-to-every-other-group&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Comparing every group to every other group&lt;/h2&gt;
&lt;p&gt;I’ve had a request to calculate disparity ratios for every group in comparison to every other group. I’m not sure this is necessarily valuable, but I’m including the following code in case it is useful to anyone else. &lt;a href=&#34;disparity_ratios.xlsx&#34;&gt;The results are saved in an Excel workbook&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;simplified_data &amp;lt;- group_rates %&amp;gt;% 
  mutate(
    # convert categories so they make sense in a sentence
    sex = case_when(
      age_range %in% c(&amp;quot;under 10&amp;quot;, &amp;quot;10-17&amp;quot;) &amp;amp; sex == &amp;quot;female&amp;quot; ~ &amp;quot;girls&amp;quot;,
      age_range %in% c(&amp;quot;under 10&amp;quot;, &amp;quot;10-17&amp;quot;) ~ &amp;quot;boys&amp;quot;,
      sex == &amp;quot;female&amp;quot; ~ &amp;quot;women&amp;quot;,
      TRUE ~ &amp;quot;men&amp;quot;
    ),
    # convert categories into a description
    group = str_glue(&amp;quot;{ethnic_group} {sex} aged {age_range}&amp;quot;)
  ) %&amp;gt;% 
  # remove all the columns we don&amp;#39;t need
  select(group, search_rate) %&amp;gt;% 
  # convert the data frame to a named vector
  deframe()

every_comparison &amp;lt;- simplified_data %&amp;gt;% 
  # multiply each value by every other value
  map_dfr(~ . / simplified_data) %&amp;gt;% 
  # add the original group names back
  mutate(group = names(simplified_data)) %&amp;gt;% 
  # move the original group names to be the first column
  select(group, everything())
  

# to create an Excel workbook with multiple sheets, we need to create a list
# of data frames, with each element in the list corresponding to a worksheet
list(
  # the first worksheet contains a table of disparity ratios 
  &amp;quot;comparisons_table&amp;quot; = rename(
    # put a description of the table in the first row of the first column
    every_comparison, 
    `Group below is X times more likely to be searched than group to right` = 
      group
  ),
  # the second worksheet contains those ratios expressed in sentences, since
  # tables of the type in the first workbook can sometimes be confusing
  &amp;quot;comparisons_descriptions&amp;quot; = every_comparison %&amp;gt;% 
    # convert the data to &amp;#39;long&amp;#39; format
    pivot_longer(., -group, names_to = &amp;quot;group2&amp;quot;, values_to = &amp;quot;disparity&amp;quot;) %&amp;gt;% 
    # remove rows that compare groups against themselves
    filter(group != group2) %&amp;gt;% 
    # write a statement comparing each pair of groups
    mutate(
      disp1 = ifelse(disparity &amp;gt; 1, disparity, 1/disparity),
      disp2 = ifelse(disparity &amp;gt; 1, &amp;quot;more&amp;quot;, &amp;quot;less&amp;quot;),
      desc = str_glue(&amp;quot;{group} are {number(disp1, accuracy = 0.1)} times &amp;quot;,
                      &amp;quot;{disp2} likely to be searched than {group2}&amp;quot;)
    ) %&amp;gt;% 
    # remove all variables except the descriptive text, and remove the column
    # name so the first row is blank
    select(` ` = desc)
) %&amp;gt;% 
  openxlsx::write.xlsx(&amp;quot;disparity_ratios.xlsx&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;conclusion&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;Disparity ratios are a common way of looking at how stop and search affects different groups in society. They are by no means perfect, since different people (and groups) might experience the same treatment in different ways for all sorts of reasons. Disparity ratios also do not explain why different groups are searched at different rates. I discuss these issues in more detail in the report, which you can &lt;a href=&#34;http://lesscrime.info/publication/stop-search-london-2020-q3/&#34;&gt;download to read for free&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&#34;footnotes&#34;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&#34;fn1&#34;&gt;&lt;p&gt;Adding in data from British Transport Police would mean we needed to remove searches conducted by BTP outside London, because they cover the whole of Great Britain. This has to be done using a spatial join, which would make this tutorial quite a lot longer.&lt;a href=&#34;#fnref1&#34; class=&#34;footnote-back&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
    </item>
    
    <item>
      <title>Tutorial: Cleaning UK Office for National Statistics data in R</title>
      <link>http://lesscrime.info/post/cleaning-ons-data/</link>
      <pubDate>Fri, 30 Aug 2019 00:00:00 +0000</pubDate>
      <guid>http://lesscrime.info/post/cleaning-ons-data/</guid>
      <description>


&lt;p&gt;TL; DR: &lt;a href=&#34;#complete&#34;&gt;skip to the complete script&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The UK &lt;a href=&#34;https://ons.gov.uk/&#34;&gt;Office for National Statistics&lt;/a&gt; (ONS) publishes a
lot of quantitative information on all the topics you’d expect from a national
statistical office, but most of it is released in formats that need manual
cleaning before they can be used for data analysis.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;&#34;&gt;ONS has started publishing some machine-readable data&lt;/a&gt;&lt;a href=&#34;#fn1&#34; class=&#34;footnote-ref&#34; id=&#34;fnref1&#34;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt;, but most products
its produces are Excel tables that are optimised for human reading by mimicking
the format of tables in the printed statistical reports that ONS produced for
decades.&lt;/p&gt;
&lt;p&gt;This tutorial talks through how to clean a human-readable table produced by ONS
using the &lt;code&gt;tidyverse&lt;/code&gt; collection of packages, so the resulting &lt;a href=&#34;http://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html&#34;&gt;tidy
data&lt;/a&gt; can
be used for analysis. As an example, we’ll use a file containing &lt;a href=&#34;https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland&#34;&gt;population
estimates for each nation within the United Kingdom&lt;/a&gt;
by five-year age groups.&lt;/p&gt;
&lt;div id=&#34;why-do-this&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Why do this?&lt;/h1&gt;
&lt;p&gt;It might be tempting not to clean the data in R but instead simply open the
relevant file in Excel and make the necessary changes there. This will work, but
there are at least three reasons why cleaning the data in Excel is not
necessarily a good idea.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;It’s harder to repeat the process&lt;/em&gt;. For example, if ONS updates the
table (either because new data is available or to correct a problem) then
you have to repeat the manual process in Excel. If you clean the data in R,
typically all you have to do is run the script again.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;It’s harder to find mistakes&lt;/em&gt;. If you make a mistake while changing data in
Excel but don’t notice until later (e.g. if your results don’t make sense)
it will be difficult to track down exactly what happened. If you use a
script to clean the data, you can go back and run it line-by-line to
identify the problem.&lt;/li&gt;
&lt;li&gt;&lt;em&gt;It’s harder for others to trust your work&lt;/em&gt;. If someone else wants to check
your analysis (e.g. before taking action based on it), that’s more difficult
if you have manipulated the data manually in ways the other person cannot
see.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div id=&#34;before-you-start&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Before you start&lt;/h1&gt;
&lt;p&gt;This tutorial assumes you have &lt;a href=&#34;https://cloud.r-project.org&#34;&gt;R&lt;/a&gt; installed and
that you’re comfortable with the basics of &lt;a href=&#34;https://www.computerworld.com/article/2497143/business-intelligence-beginner-s-guide-to-r-introduction.html&#34;&gt;using R to manipulate data&lt;/a&gt;.
If you don’t have the tidyverse collection of packages installed already, run
&lt;code&gt;install.packages(&#34;tidyverse&#34;)&lt;/code&gt; before continuing. It also a good idea to run
this code from &lt;a href=&#34;https://www.tidyverse.org/articles/2017/12/workflow-vs-script/&#34;&gt;inside a project&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;download&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Download the data&lt;/h1&gt;
&lt;p&gt;Although ONS is relatively good at providing archive data, it’s good practice to
always save an unamended copy of the raw data for any project just in case it
later disappears from the source website.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;# download the data file
download.file(
  url = &amp;quot;https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/populationestimatesforukenglandandwalesscotlandandnorthernireland/mid20182019laboundaries/ukmidyearestimates20182019ladcodes.xls&amp;quot;,
  destfile = &amp;quot;ons_pop_data.xls&amp;quot;
)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;load&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Load the data into R&lt;/h1&gt;
&lt;p&gt;Since the data are in an Excel file, we can use the &lt;a href=&#34;https://readxl.tidyverse.org&#34;&gt;&lt;code&gt;readxl&lt;/code&gt;&lt;/a&gt;
package to read it into R&lt;a href=&#34;#fn2&#34; class=&#34;footnote-ref&#34; id=&#34;fnref2&#34;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt;. ONS publishes data using a mixture of file formats,
including both the pre-2007 Excel &lt;code&gt;.xls&lt;/code&gt; file format and the current &lt;code&gt;.xlsx&lt;/code&gt;
format&lt;a href=&#34;#fn3&#34; class=&#34;footnote-ref&#34; id=&#34;fnref3&#34;&gt;&lt;sup&gt;3&lt;/sup&gt;&lt;/a&gt;. The &lt;code&gt;read_excel()&lt;/code&gt; function can handle both &lt;code&gt;.xls&lt;/code&gt; and &lt;code&gt;.xlsx&lt;/code&gt;
files, but can only load a single sheet from within an Excel workbook (i.e. 
file). We can use the &lt;code&gt;excel_sheets()&lt;/code&gt; function to get the names of each sheet
in the Excel file.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(&amp;quot;readxl&amp;quot;)
library(&amp;quot;tidyverse&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## ── Attaching packages ─────────────────────────────────────── tidyverse 1.3.0 ──&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## ✓ ggplot2 3.3.2     ✓ purrr   0.3.4
## ✓ tibble  3.0.4     ✓ dplyr   1.0.2
## ✓ tidyr   1.1.2     ✓ stringr 1.4.0
## ✓ readr   1.4.0     ✓ forcats 0.5.0&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: package &amp;#39;ggplot2&amp;#39; was built under R version 4.0.2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: package &amp;#39;tibble&amp;#39; was built under R version 4.0.2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: package &amp;#39;tidyr&amp;#39; was built under R version 4.0.2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: package &amp;#39;readr&amp;#39; was built under R version 4.0.2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## Warning: package &amp;#39;dplyr&amp;#39; was built under R version 4.0.2&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## ── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
## x dplyr::filter() masks stats::filter()
## x dplyr::lag()    masks stats::lag()&lt;/code&gt;&lt;/pre&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;excel_sheets(&amp;quot;ons_pop_data.xls&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;##  [1] &amp;quot;Contents &amp;quot;                  &amp;quot;Terms and conditions &amp;quot;     
##  [3] &amp;quot;Notes and definitions&amp;quot;      &amp;quot;Admin. geography hierarchy&amp;quot;
##  [5] &amp;quot;MYE1&amp;quot;                       &amp;quot;MYE2-All&amp;quot;                  
##  [7] &amp;quot;MYE2 - Males&amp;quot;               &amp;quot;MYE2 - Females&amp;quot;            
##  [9] &amp;quot;MYE3&amp;quot;                       &amp;quot;MYE4 &amp;quot;                     
## [11] &amp;quot;MYE 5&amp;quot;                      &amp;quot;MYE 6&amp;quot;                     
## [13] &amp;quot;Related publications&amp;quot;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Note that some of the sheets have a space at the end of the name, which will be
invisible when viewing the file in Excel but which we need to know about to
specify the sheet name for &lt;code&gt;read_excel()&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;Contents&lt;/code&gt; sheet contains a short description of the data in each of the
other sheets. There are blank rows between every row in this table (an example
of how ONS optimises for human rather than computer readability), but we can
remove these rows using the &lt;code&gt;drop_na()&lt;/code&gt; function from the &lt;code&gt;tidyr&lt;/code&gt; package.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;drop_na(read_excel(&amp;quot;ons_pop_data.xls&amp;quot;, sheet = &amp;quot;Contents &amp;quot;))&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 12 x 2
##    Contents             `Population Estimates for UK, England and Wales, Scotla…
##    &amp;lt;chr&amp;gt;                &amp;lt;chr&amp;gt;                                                   
##  1 Terms and conditions Terms and conditions                                    
##  2 Notes and definitio… Notes and definitions                                   
##  3 Admin. geography hi… Administrative geography hierarchy for the United Kingd…
##  4 MYE1                 Population estimates: Summary for the UK, mid-2018      
##  5 MYE2 - All           Population estimates: Persons by single year of age and…
##  6 MYE2 - M             Population estimates: Males by single year of age and s…
##  7 MYE2 - F             Population estimates: Females by single year of age and…
##  8 MYE3                 Components of population change for local authorities i…
##  9 MYE4                 Population estimates: Summary for the UK, mid-1971 to m…
## 10 MYE5                 Population estimates: Population density for local auth…
## 11 MYE6                 Median age of population for local authorities in the U…
## 12 Related publications Provides links to further population statistics &amp;amp; relat…&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We’re going to use the data from the mid-2018 UK population summary, so we want
the &lt;code&gt;MYE1&lt;/code&gt; sheet. We can now use &lt;code&gt;read_excel()&lt;/code&gt; to load the data.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;file_data &amp;lt;- read_excel(&amp;quot;ons_pop_data.xls&amp;quot;, sheet = &amp;quot;MYE1&amp;quot;)&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## New names:
## * `` -&amp;gt; ...2
## * `` -&amp;gt; ...3
## * `` -&amp;gt; ...4
## * `` -&amp;gt; ...5
## * `` -&amp;gt; ...6
## * ...&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;clean&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Clean the data&lt;/h1&gt;
&lt;p&gt;In Excel, the &lt;code&gt;MYE1&lt;/code&gt; sheet looks like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;http://lesscrime.info/post/cleaning-ons-data/mye1-sheet-preview.png&#34; /&gt;&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;file_data&lt;/code&gt; object contains the result of the &lt;code&gt;read_excel()&lt;/code&gt; function’s
attempt to load this sheet into R:&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;file_data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 33 x 9
##    Contents     ...2   ...3   ...4   ...5   ...6      ...7     ...8     ...9    
##    &amp;lt;chr&amp;gt;        &amp;lt;chr&amp;gt;  &amp;lt;chr&amp;gt;  &amp;lt;chr&amp;gt;  &amp;lt;chr&amp;gt;  &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;    &amp;lt;chr&amp;gt;    &amp;lt;chr&amp;gt;   
##  1 &amp;lt;NA&amp;gt;         &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;   
##  2 MYE1: Popul… &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;quot;Please … This me… I need … &amp;quot;This i…
##  3 &amp;lt;NA&amp;gt;         &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;   
##  4 Country / C… K0200… K0300… K0400… E9200… &amp;quot;W920000… S920000… N920000…  &amp;lt;NA&amp;gt;   
##  5 &amp;lt;NA&amp;gt;         UNITE… GREAT… ENGLA… ENGLA… &amp;quot;WALES&amp;quot;   SCOTLAND NORTHER…  &amp;lt;NA&amp;gt;   
##  6 &amp;lt;NA&amp;gt;         &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;   
##  7 All Persons  66435… 64553… 59115… 55977… &amp;quot;3138631&amp;quot; 5438100  1881641   &amp;lt;NA&amp;gt;   
##  8 Males        32790… 31864… 29215… 27667… &amp;quot;1547309&amp;quot; 2648751  926200    &amp;lt;NA&amp;gt;   
##  9 Females      33645… 32689… 29900… 28309… &amp;quot;1591322&amp;quot; 2789349  955441    &amp;lt;NA&amp;gt;   
## 10 &amp;lt;NA&amp;gt;         &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;   &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;     &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;   
## # … with 23 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This isn’t very useful. There are several problems we need to fix:&lt;/p&gt;
&lt;ol style=&#34;list-style-type: decimal&#34;&gt;
&lt;li&gt;the column names don’t reflect the data in each column,&lt;/li&gt;
&lt;li&gt;all the columns have the type &lt;code&gt;&amp;lt;chr&amp;gt;&lt;/code&gt; (character) even when the columns
contain numbers,&lt;/li&gt;
&lt;li&gt;there are several blank or partially blank rows,&lt;/li&gt;
&lt;li&gt;the feedback questionnaire in the top-left corner of the sheet means
&lt;code&gt;file_data&lt;/code&gt; contains an extra column,&lt;/li&gt;
&lt;li&gt;there is a row containing a footnote,&lt;/li&gt;
&lt;li&gt;the data are in wide rather than long format.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We can fix all of these either using the parameters of &lt;code&gt;read_excel()&lt;/code&gt; or&lt;br /&gt;
functions from the tidyverse packages.&lt;/p&gt;
&lt;p&gt;We can exclude all the cells in the sheet except those containing data with the
&lt;code&gt;range =&lt;/code&gt; parameter of &lt;code&gt;read_excel()&lt;/code&gt;. We can either specify the cell range
manually (e.g. &lt;code&gt;range = &#34;A5:H31&#34;&lt;/code&gt;) or we can use one of the &lt;code&gt;cell_*&lt;/code&gt; collection
of helper functions from the &lt;code&gt;cellranger&lt;/code&gt; package, which is loaded with
&lt;code&gt;readxl&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We can work out which cells we want to retain either by opening the file in
Excel and noting which rows contain the data, or by running &lt;code&gt;View(file_data)&lt;/code&gt; in
R and then adjusting the value of &lt;code&gt;range =&lt;/code&gt; in &lt;code&gt;read_excel()&lt;/code&gt; until we are
happy with the result.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;file_data &amp;lt;- read_excel(&amp;quot;ons_pop_data.xls&amp;quot;,
  sheet = &amp;quot;MYE1&amp;quot;,
  range = cell_rows(5:31)
)

file_data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 26 x 8
##    `Country / Code` K02000001 K03000001 K04000001 E92000001 W92000004 S92000003
##    &amp;lt;chr&amp;gt;            &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;     &amp;lt;chr&amp;gt;    
##  1 &amp;lt;NA&amp;gt;             UNITED K… GREAT BR… ENGLAND … ENGLAND   WALES     SCOTLAND 
##  2 &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;     
##  3 All Persons      66435550  64553909  59115809  55977178  3138631   5438100  
##  4 Males            32790202  31864002  29215251  27667942  1547309   2648751  
##  5 Females          33645348  32689907  29900558  28309236  1591322   2789349  
##  6 &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;     
##  7 Age Groups       &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;      &amp;lt;NA&amp;gt;     
##  8 0-4              3914028   3792292   3515430   3346727   168703    276862   
##  9 5-9              4138524   4009409   3708320   3523866   184454    301089   
## 10 10-14            3858894   3738572   3450782   3274119   176663    287790   
## # … with 16 more rows, and 1 more variable: N92000002 &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This deals with the unwanted rows above and below the table, as well as the
unwanted columns produced because of the feedback questionnaire.&lt;/p&gt;
&lt;p&gt;The next problem is that the column names represent the &lt;a href=&#34;https://webarchive.nationalarchives.gov.uk/20160106185615/http://www.ons.gov.uk/ons/guide-method/geography/beginner-s-guide/index.html&#34;&gt;GSS statistical
codes&lt;/a&gt;
for the different nations of the UK, rather than the names of the nations. You
may prefer the codes, but we’ll assume that you want the names.&lt;/p&gt;
&lt;p&gt;We can use functions from the &lt;code&gt;magrittr&lt;/code&gt; package to work with individual values
in the data. All these functions are aliases for base R functions, but can be
easier to work with.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;library(&amp;quot;magrittr&amp;quot;)

# set a value for the first row in the first column, which is currently blank
file_data[1, 1] &amp;lt;- &amp;quot;group&amp;quot;

# replace the existing column names with the values from the first row
file_data &amp;lt;- set_colnames(file_data, file_data[1, ])

# remove the first row, which we no longer need, using slice() from dplyr
file_data &amp;lt;- slice(file_data, 2:n())

file_data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 25 x 8
##    group `UNITED KINGDOM` `GREAT BRITAIN` `ENGLAND AND WA… ENGLAND WALES
##    &amp;lt;chr&amp;gt; &amp;lt;chr&amp;gt;            &amp;lt;chr&amp;gt;           &amp;lt;chr&amp;gt;            &amp;lt;chr&amp;gt;   &amp;lt;chr&amp;gt;
##  1 &amp;lt;NA&amp;gt;  &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;            &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt; 
##  2 All … 66435550         64553909        59115809         559771… 3138…
##  3 Males 32790202         31864002        29215251         276679… 1547…
##  4 Fema… 33645348         32689907        29900558         283092… 1591…
##  5 &amp;lt;NA&amp;gt;  &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;            &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt; 
##  6 Age … &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;            &amp;lt;NA&amp;gt;             &amp;lt;NA&amp;gt;    &amp;lt;NA&amp;gt; 
##  7 0-4   3914028          3792292         3515430          3346727 1687…
##  8 5-9   4138524          4009409         3708320          3523866 1844…
##  9 10-14 3858894          3738572         3450782          3274119 1766…
## 10 15-19 3669250          3555359         3270795          3096575 1742…
## # … with 15 more rows, and 2 more variables: SCOTLAND &amp;lt;chr&amp;gt;, `NORTHERN
## #   IRELAND` &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next we remove any rows containing empty cells, since none of the data rows
contain empty cells (see &lt;a href=&#34;#tips&#34;&gt;Tips&lt;/a&gt;, below, for tables where this isn’t the
case).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;file_data &amp;lt;- drop_na(file_data)

file_data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 22 x 8
##    group `UNITED KINGDOM` `GREAT BRITAIN` `ENGLAND AND WA… ENGLAND WALES
##    &amp;lt;chr&amp;gt; &amp;lt;chr&amp;gt;            &amp;lt;chr&amp;gt;           &amp;lt;chr&amp;gt;            &amp;lt;chr&amp;gt;   &amp;lt;chr&amp;gt;
##  1 All … 66435550         64553909        59115809         559771… 3138…
##  2 Males 32790202         31864002        29215251         276679… 1547…
##  3 Fema… 33645348         32689907        29900558         283092… 1591…
##  4 0-4   3914028          3792292         3515430          3346727 1687…
##  5 5-9   4138524          4009409         3708320          3523866 1844…
##  6 10-14 3858894          3738572         3450782          3274119 1766…
##  7 15-19 3669250          3555359         3270795          3096575 1742…
##  8 20-24 4184575          4068584         3717960          3512654 2053…
##  9 25-29 4527175          4404612         4022272          3815924 2063…
## 10 30-34 4463357          4337288         3976030          3787597 1884…
## # … with 12 more rows, and 2 more variables: SCOTLAND &amp;lt;chr&amp;gt;, `NORTHERN
## #   IRELAND` &amp;lt;chr&amp;gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can convert the data from wide to long using &lt;code&gt;gather()&lt;/code&gt; from the &lt;code&gt;tidyr&lt;/code&gt;
package. &lt;code&gt;gather()&lt;/code&gt; can be a slightly confusing function to use, but there are
some useful tutorials available by &lt;a href=&#34;https://garrettgman.github.io/tidying/#gather&#34;&gt;Garrett Grolemund&lt;/a&gt;, &lt;a href=&#34;https://uc-r.github.io/tidyr#gather--function&#34;&gt;UC Business Analytics&lt;/a&gt; and &lt;a href=&#34;https://r4ds.had.co.nz/tidy-data.html#spreading-and-gathering&#34;&gt;R for Data
Science&lt;/a&gt;.&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;file_data &amp;lt;- gather(file_data, key = &amp;quot;geography&amp;quot;, value = &amp;quot;population&amp;quot;, -group)

file_data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 154 x 3
##    group       geography      population
##    &amp;lt;chr&amp;gt;       &amp;lt;chr&amp;gt;          &amp;lt;chr&amp;gt;     
##  1 All Persons UNITED KINGDOM 66435550  
##  2 Males       UNITED KINGDOM 32790202  
##  3 Females     UNITED KINGDOM 33645348  
##  4 0-4         UNITED KINGDOM 3914028   
##  5 5-9         UNITED KINGDOM 4138524   
##  6 10-14       UNITED KINGDOM 3858894   
##  7 15-19       UNITED KINGDOM 3669250   
##  8 20-24       UNITED KINGDOM 4184575   
##  9 25-29       UNITED KINGDOM 4527175   
## 10 30-34       UNITED KINGDOM 4463357   
## # … with 144 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Finally, we will neaten the data by converting the population variable to
numeric and the geography variable to title case (using a function from the
&lt;code&gt;stringr&lt;/code&gt; package).&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;tidy_data &amp;lt;- mutate(
  file_data,
  geography = str_to_title(geography),
  population = as.numeric(population)
)

tidy_data&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;## # A tibble: 154 x 3
##    group       geography      population
##    &amp;lt;chr&amp;gt;       &amp;lt;chr&amp;gt;               &amp;lt;dbl&amp;gt;
##  1 All Persons United Kingdom   66435550
##  2 Males       United Kingdom   32790202
##  3 Females     United Kingdom   33645348
##  4 0-4         United Kingdom    3914028
##  5 5-9         United Kingdom    4138524
##  6 10-14       United Kingdom    3858894
##  7 15-19       United Kingdom    3669250
##  8 20-24       United Kingdom    4184575
##  9 25-29       United Kingdom    4527175
## 10 30-34       United Kingdom    4463357
## # … with 144 more rows&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;complete&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;A complete script&lt;/h1&gt;
&lt;p&gt;Using the &lt;a href=&#34;https://cran.r-project.org/package=magrittr/vignettes/magrittr.html&#34;&gt;&lt;code&gt;magrittr&lt;/code&gt; pipe &lt;code&gt;%&amp;gt;%&lt;/code&gt;&lt;/a&gt;,
we can combine all these cleaning steps together, which makes the code more
compact and (arguably) more readable.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;library(&amp;quot;lubridate&amp;quot;) # lubridate and magrittr are part of the
library(&amp;quot;magrittr&amp;quot;) # tidyverse but not loaded with it by default
library(&amp;quot;readxl&amp;quot;)
library(&amp;quot;tidyverse&amp;quot;)

tidy_data &amp;lt;- read_excel(&amp;quot;ons_pop_data.xls&amp;quot;,
  sheet = &amp;quot;MYE1&amp;quot;,
  range = cell_rows(5:31)
) %&amp;gt;%
  inset(1, 1, &amp;quot;group&amp;quot;) %&amp;gt;%
  set_colnames(.[1, ]) %&amp;gt;%
  slice(2:n()) %&amp;gt;%
  drop_na() %&amp;gt;%
  gather(key = &amp;quot;geography&amp;quot;, value = &amp;quot;population&amp;quot;, -group) %&amp;gt;%
  mutate(
    geography = str_to_title(geography),
    population = as.numeric(population)
  )
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;tips&#34; class=&#34;section level1&#34;&gt;
&lt;h1&gt;Tips for other ONS tables&lt;/h1&gt;
&lt;p&gt;There is a huge number of ONS tables available, some having different formatting
issues from those mentioned above. These are some of the issues I’ve come across
and potential ways to deal with them.&lt;/p&gt;
&lt;p&gt;(The examples below all assume your data is in a data frame/tibble called
&lt;code&gt;data&lt;/code&gt;.)&lt;/p&gt;
&lt;div id=&#34;missing-values-in-the-data&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Missing values in the data&lt;/h2&gt;
&lt;p&gt;Many ONS datasets have missing values, and some even have multiple
values representing different reasons for the values being missing. For example,
data for small geographic areas might be missing because the data could not be
collected for a particular location or have been redacted to prevent disclosure
of personal information.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;na =&lt;/code&gt; parameter of &lt;code&gt;read_excel()&lt;/code&gt; can be used to specify values in the
data that should be treated as missing. For example, if an ONS table uses a
blank cell to represent data that could not be collected and &lt;code&gt;**&lt;/code&gt; to represent
redacted data, &lt;code&gt;read_excel(&#34;data.xlsx&#34;, sheet = &#34;Sheet 1&#34;, na = c(&#34;&#34;, &#34;**&#34;))&lt;/code&gt;
will ensure both values are represented by &lt;code&gt;NA&lt;/code&gt; in R.&lt;/p&gt;
&lt;p&gt;It isn’t possible to use &lt;code&gt;drop_na()&lt;/code&gt; to remove empty rows if there are missing
values in the data, because &lt;code&gt;drop_na()&lt;/code&gt; removes rows that contain &lt;em&gt;any&lt;/em&gt; missing
values. Instead, you can use &lt;code&gt;remove_empty()&lt;/code&gt; from the &lt;code&gt;janitor&lt;/code&gt; package to
remove rows or columns that are entirely empty. If there are rows that you want
to remove from the data that contain some missing values and some values that
are not missing, use &lt;code&gt;filter()&lt;/code&gt; from &lt;code&gt;dplyr&lt;/code&gt; based on the value of a specific
column. For example, to remove rows with the value of &lt;code&gt;population&lt;/code&gt; missing,
use &lt;code&gt;filter(data, !is.na(population))&lt;/code&gt;. To remove single rows manually by row
number, use &lt;code&gt;slice()&lt;/code&gt;, also from &lt;code&gt;dplyr&lt;/code&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;multiple-tables-in-a-single-sheet&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Multiple tables in a single sheet&lt;/h2&gt;
&lt;p&gt;Sometimes multiple related data tables are placed on a single Excel sheet. You
can either import them separately and then combine the resulting datasets
manually (e.g. with &lt;code&gt;rbind()&lt;/code&gt;) or just treat the rows or columns between each
table as clutter that can be removed using a combination of &lt;code&gt;drop_na()&lt;/code&gt; and
&lt;code&gt;slice()&lt;/code&gt; as above. In the latter case, modify the &lt;code&gt;range =&lt;/code&gt; argument of
&lt;code&gt;read_excel()&lt;/code&gt; so that the selected cells/rows/columns include all the tables.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;category-names-or-values-with-footnote-markers&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Category names or values with footnote markers&lt;/h2&gt;
&lt;p&gt;If tables have multiple footnotes, some categories or values may end in a
footnote marker (typically a number). To remove these, use &lt;code&gt;str_remove()&lt;/code&gt; from
&lt;code&gt;stringr&lt;/code&gt;. For example, if the column &lt;code&gt;place&lt;/code&gt; contains values with footnote
markers, you can use &lt;code&gt;mutate(data, place = str_remove(place, &#34;\\d+$&#34;))&lt;/code&gt; to
remove them, where &lt;code&gt;\\d+&lt;/code&gt; is a &lt;a href=&#34;https://stringr.tidyverse.org/articles/regular-expressions.html#matching-multiple-characters&#34;&gt;regular expression that matches one or more
numeric characters&lt;/a&gt;
and &lt;a href=&#34;https://stringr.tidyverse.org/articles/regular-expressions.html#anchors&#34;&gt;&lt;code&gt;$&lt;/code&gt; matches only numeric characters at the end of the
value&lt;/a&gt;
of &lt;code&gt;place&lt;/code&gt;. This only works for non-numeric values with numeric footnote
markers, since the regular expression &lt;code&gt;\\d+$&lt;/code&gt; will match any sequence of numbers
at the end of a cell.&lt;/p&gt;
&lt;/div&gt;
&lt;div id=&#34;dates-and-date-ranges-stored-as-text&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;Dates and date ranges stored as text&lt;/h2&gt;
&lt;p&gt;Since many ONS statistics are published for financial years, time periods are
often stored as strings showing, for example, &lt;code&gt;2018-19&lt;/code&gt;. Converting these to
dates helps with things like plotting values on an axis with date values or
using the data in a time-series model.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;lubridate&lt;/code&gt; package is very useful for converting dates. You can either
represent each date as a specific moment in time, or as an interval in time.
For example, if a financial year is stored as &lt;code&gt;2018-19&lt;/code&gt; in the &lt;code&gt;year&lt;/code&gt; column,
you can extract the specific moment the year started using
&lt;code&gt;mutate(year_beginning = ymd(paste(str_sub(year, 0, 4)), &#34;04&#34;, &#34;01&#34;))&lt;/code&gt;. In this
code, &lt;code&gt;str_sub(year, 0, 4)&lt;/code&gt; extracts the first four characters from the string
&lt;code&gt;2018-19&lt;/code&gt;, &lt;code&gt;paste()&lt;/code&gt; creates a single character value for 1 April in the given
year (e.g. &lt;code&gt;2018 04 01&lt;/code&gt;) and &lt;code&gt;ymd()&lt;/code&gt; converts that string into a date object.&lt;/p&gt;
&lt;p&gt;To store a date as an interval, we extract both the date on which the year
started and the date it ended. For example,&lt;/p&gt;
&lt;pre class=&#34;r&#34;&gt;&lt;code&gt;mutate(
  data,
  year_interval = interval(
    ymd(paste(str_sub(year, 0, 4), &amp;quot;04&amp;quot;, &amp;quot;01&amp;quot;)),
    ymd(paste(str_sub(year, -2), &amp;quot;03&amp;quot;, &amp;quot;31&amp;quot;))
  )
)&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;div id=&#34;r-session-information&#34; class=&#34;section level2&#34;&gt;
&lt;h2&gt;R session information&lt;/h2&gt;
&lt;p&gt;The code in this tutorial was run in R with the following configuration:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;## R version 4.0.1 (2020-06-06)
## Platform: x86_64-apple-darwin17.0 (64-bit)
## Running under: macOS Catalina 10.15.6
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRblas.dylib
## LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib
## 
## locale:
## [1] en_GB.UTF-8/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
##  [1] magrittr_1.5    forcats_0.5.0   stringr_1.4.0   dplyr_1.0.2    
##  [5] purrr_0.3.4     readr_1.4.0     tidyr_1.1.2     tibble_3.0.4   
##  [9] ggplot2_3.3.2   tidyverse_1.3.0 readxl_1.3.1   
## 
## loaded via a namespace (and not attached):
##  [1] tidyselect_1.1.0 xfun_0.18        haven_2.3.1      colorspace_1.4-1
##  [5] vctrs_0.3.4      generics_0.0.2   htmltools_0.5.0  yaml_2.2.1      
##  [9] utf8_1.1.4       blob_1.2.1       rlang_0.4.8      pillar_1.4.6    
## [13] glue_1.4.2       withr_2.3.0      DBI_1.1.0        dbplyr_1.4.4    
## [17] modelr_0.1.8     lifecycle_0.2.0  munsell_0.5.0    blogdown_0.21   
## [21] gtable_0.3.0     cellranger_1.1.0 rvest_0.3.6      evaluate_0.14   
## [25] knitr_1.30       fansi_0.4.1      broom_0.7.1      Rcpp_1.0.5      
## [29] scales_1.1.1     backports_1.1.10 jsonlite_1.7.1   fs_1.5.0        
## [33] hms_0.5.3        digest_0.6.26    stringi_1.5.3    bookdown_0.21   
## [37] grid_4.0.1       cli_2.1.0        tools_4.0.1      crayon_1.3.4    
## [41] pkgconfig_2.0.3  ellipsis_0.3.1   xml2_1.3.2       reprex_0.3.0    
## [45] lubridate_1.7.9  assertthat_0.2.1 rmarkdown_2.4    httr_1.4.2      
## [49] rstudioapi_0.11  R6_2.4.1         compiler_4.0.1&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&#34;footnotes&#34;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&#34;fn1&#34;&gt;&lt;p&gt;ONS refers to this as ‘open data’, although (almost) all the products it
produces are already &lt;a href=&#34;https://www.ons.gov.uk/methodology/geography/licences&#34;&gt;open licensed under the Open Government
Licence&lt;/a&gt;&lt;a href=&#34;#fnref1&#34; class=&#34;footnote-back&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&#34;fn2&#34;&gt;&lt;p&gt;The &lt;code&gt;readxl&lt;/code&gt; package is &lt;a href=&#34;https://www.tidyverse.org/packages/&#34;&gt;installed as part of the
tidyverse&lt;/a&gt; but is not automatically loaded
by &lt;code&gt;library(&#34;tidyverse&#34;)&lt;/code&gt;.&lt;a href=&#34;#fnref2&#34; class=&#34;footnote-back&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&#34;fn3&#34;&gt;&lt;p&gt;I have not been able to work out why some ONS files are in &lt;code&gt;.xls&lt;/code&gt; format
and some in &lt;code&gt;.xlsx&lt;/code&gt;.&lt;a href=&#34;#fnref3&#34; class=&#34;footnote-back&#34;&gt;↩︎&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
</description>
    </item>
    
  </channel>
</rss>
